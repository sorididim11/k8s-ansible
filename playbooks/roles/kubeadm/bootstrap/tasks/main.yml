---



- name: Init kubernetes
  become: yes
  command: kubeadm init --apiserver-advertise-address={{inventory_hostname}} --pod-network-cidr=10.244.0.0/16

# to make kubectl work for your non-root user
# mkdir -p $HOME/.kube
# sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
# sudo chown $(id -u):$(id -g) $HOME/.kube/config
- block:
  - name: create dir 
    file: 
      path: ~/.kube
      state: directory

  - set_fact:
      user_name: "{{ ansible_user_id }}"
      user_home: "{{ ansible_user_dir }}"
    
  - name: copy admin.conf
    become: yes
    copy: 
      src: /etc/kubernetes/admin.conf
      dest: "{{user_home}}/.kube/config"
      owner: "{{user_name}}"
      group: "{{user_name}}"
      remote_src: yes

- name: Install Pod network
  command: kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/v0.10.0/Documentation/kube-flannel.yml


